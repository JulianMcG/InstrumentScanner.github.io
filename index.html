<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Band Instrument Scanner</title>
    
    <!-- PWA: Make it a fullscreen app when added to homescreen -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#18181b">

    <!-- PWA: Icons (You should replace these with your own) -->
    <link rel="apple-touch-icon" href="https://placehold.co/180x180/18181b/ffffff?text=BandApp">
    <!-- You will need to create a manifest.json file for full Android support. See README. -->
    <link rel="manifest" href="manifest.json">

    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- jsQR for barcode scanning -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

    <style>
        /* Custom styles for a better mobile experience */
        body {
            -webkit-tap-highlight-color: transparent;
            font-family: 'Inter', sans-serif;
        }
        /* Style for the scanner overlay */
        #scanner-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        #video-feed {
            width: 85%;
            max-width: 500px;
            border-radius: 1rem;
            border: 2px solid #3f3f46;
        }
        /* Custom focus styles for better accessibility */
        .form-input:focus {
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5);
        }
        .btn:active {
            transform: scale(0.98);
        }
    </style>
</head>
<body class="bg-zinc-900 text-white flex items-center justify-center min-h-screen">

    <div class="w-full max-w-md mx-auto p-6 space-y-6">
        <header class="text-center">
            <h1 class="text-3xl font-bold tracking-tight">Instrument Checkout</h1>
            <p class="text-zinc-400">Scan an instrument and assign it to a student.</p>
        </header>

        <!-- Main Form -->
        <main class="space-y-4">
            <div>
                <label for="studentName" class="block text-sm font-medium text-zinc-300 mb-1">Student Name</label>
                <input type="text" id="studentName" class="form-input bg-zinc-800 border-zinc-700 w-full rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., Jane Doe">
            </div>
             <div>
                <label for="instrumentName" class="block text-sm font-medium text-zinc-300 mb-1">Instrument Name</label>
                <input type="text" id="instrumentName" class="form-input bg-zinc-800 border-zinc-700 w-full rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., Trumpet, Flute">
            </div>
            <div>
                <label for="serialNumber" class="block text-sm font-medium text-zinc-300 mb-1">Serial Number (from scan)</label>
                <div class="flex gap-2">
                    <input type="text" id="serialNumber" readonly class="form-input bg-zinc-900 border-zinc-700 w-full rounded-lg p-3 text-zinc-400 cursor-not-allowed" placeholder="Scan barcode...">
                    <button id="scanButton" class="btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-5 rounded-lg transition-transform duration-150 ease-in-out flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 7V5a2 2 0 0 1 2-2h2"/><path d="M17 3h2a2 2 0 0 1 2 2v2"/><path d="M21 17v2a2 2 0 0 1-2 2h-2"/><path d="M7 21H5a2 2 0 0 1-2-2v-2"/><path d="M7 12h10"/></svg>
                        Scan
                    </button>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="grid grid-cols-2 gap-4 pt-4">
                <button id="checkOutButton" class="btn bg-green-600 hover:bg-green-700 text-white font-bold py-4 rounded-lg transition-transform duration-150 ease-in-out">Check Out</button>
                <button id="checkInButton" class="btn bg-red-600 hover:bg-red-700 text-white font-bold py-4 rounded-lg transition-transform duration-150 ease-in-out">Check In</button>
            </div>
        </main>

        <!-- Status Message Area -->
        <div id="statusMessage" class="text-center p-3 rounded-lg min-h-[50px] transition-opacity duration-300"></div>
    </div>

    <!-- Scanner UI (hidden by default) -->
    <div id="scanner-container" class="hidden">
        <video id="video-feed" playsinline></video>
        <button id="cancelScanButton" class="btn mt-6 bg-zinc-700 hover:bg-zinc-600 text-white font-bold py-3 px-6 rounded-lg">Cancel</button>
    </div>
    
    <!-- Hidden canvas for processing video frames -->
    <canvas id="canvas" class="hidden"></canvas>


    <script>
        // --- CONFIGURATION ---
        // PASTE YOUR GOOGLE APPS SCRIPT URL HERE
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx9q8C5l7ME7Lxr-qhCj3jbyPcUmXdI-q743jwucgJRp5G6837c1kxWFQ7Z_fuxu-N7YQ/exec';

        // --- DOM ELEMENTS ---
        const studentNameInput = document.getElementById('studentName');
        const instrumentNameInput = document.getElementById('instrumentName');
        const serialNumberInput = document.getElementById('serialNumber');
        const scanButton = document.getElementById('scanButton');
        const checkOutButton = document.getElementById('checkOutButton');
        const checkInButton = document.getElementById('checkInButton');
        const statusMessage = document.getElementById('statusMessage');
        const scannerContainer = document.getElementById('scanner-container');
        const video = document.getElementById('video-feed');
        const canvasElement = document.getElementById('canvas');
        const canvas = canvasElement.getContext('2d');
        const cancelScanButton = document.getElementById('cancelScanButton');

        let stream = null;
        let animationFrameId = null;

        // --- FUNCTIONS ---
        
        function startScanner() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                showStatus('Camera not supported on this device.', 'error');
                return;
            }
            scannerContainer.classList.remove('hidden');
            navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                .then(function(s) {
                    stream = s;
                    video.srcObject = stream;
                    video.play();
                    animationFrameId = requestAnimationFrame(tick);
                })
                .catch(function(err) {
                    console.error("Camera Error:", err);
                    showStatus('Could not access the camera.', 'error');
                    stopScanner();
                });
        }

        function stopScanner() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
            }
            scannerContainer.classList.add('hidden');
        }

        function tick() {
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                canvasElement.height = video.videoHeight;
                canvasElement.width = video.videoWidth;
                canvas.drawImage(video, 0, 0, canvasElement.width, canvasElement.height);
                const imageData = canvas.getImageData(0, 0, canvasElement.width, canvasElement.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height, {
                    inversionAttempts: 'dontInvert',
                });

                if (code) {
                    serialNumberInput.value = code.data;
                    stopScanner();
                    showStatus(`Scanned: ${code.data}`, 'success');
                     // Vibrate for feedback
                    if (navigator.vibrate) {
                        navigator.vibrate(200);
                    }
                } else {
                    animationFrameId = requestAnimationFrame(tick);
                }
            } else {
                 animationFrameId = requestAnimationFrame(tick);
            }
        }

        function showStatus(message, type) {
            statusMessage.textContent = message;
            statusMessage.classList.remove('bg-green-900', 'bg-red-900', 'bg-blue-900', 'text-green-300', 'text-red-300', 'text-blue-300');
            if (type === 'success') {
                statusMessage.classList.add('bg-green-900', 'text-green-300');
            } else if (type === 'error') {
                statusMessage.classList.add('bg-red-900', 'text-red-300');
            } else if (type === 'loading') {
                statusMessage.classList.add('bg-blue-900', 'text-blue-300');
            }
            setTimeout(() => {
                 if(type !== 'loading') statusMessage.textContent = '';
            }, 5000);
        }

        function handleSubmit(status) {
            const studentName = studentNameInput.value.trim();
            const instrumentName = instrumentNameInput.value.trim();
            const serialNumber = serialNumberInput.value.trim();
            
            if (GOOGLE_SCRIPT_URL === '') {
                showStatus('ERROR: Google Script URL is not configured.', 'error');
                return;
            }
            if (!studentName || !serialNumber || !instrumentName) {
                showStatus('Please fill all fields and scan a barcode.', 'error');
                return;
            }

            showStatus('Submitting to Google Sheet...', 'loading');
            checkOutButton.disabled = true;
            checkInButton.disabled = true;

            const payload = {
                name: studentName,
                instrument: instrumentName,
                serial: serialNumber,
                status: status
            };

            fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors', // Important for Apps Script
                cache: 'no-cache',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload),
                redirect: 'follow',
            })
            .then(response => {
                // 'no-cors' mode means we can't inspect the response, but we can assume success if the request didn't throw
                showStatus(`Instrument successfully ${status.toLowerCase()}!`, 'success');
                // Clear fields for next entry
                studentNameInput.value = '';
                instrumentNameInput.value = '';
                serialNumberInput.value = '';
            })
            .catch(error => {
                console.error('Error:', error);
                showStatus('Failed to submit. Check console.', 'error');
            })
            .finally(() => {
                checkOutButton.disabled = false;
                checkInButton.disabled = false;
            });
        }

        // --- EVENT LISTENERS ---
        scanButton.addEventListener('click', startScanner);
        cancelScanButton.addEventListener('click', stopScanner);
        checkOutButton.addEventListener('click', () => handleSubmit('Checked out'));
        checkInButton.addEventListener('click', () => handleSubmit('Checked in'));

    </script>
</body>
</html>
